title: New Relic Policy Setup
name: newrelic-stack-setup
description: This is used to configure the New Relic Dynamic Group, Policies, Key Vault and Link to the Newrelic Account.
schemaVersion: 1.1.0
version: 1.0
locale: "en"
groupings:
  - title: "New Relic Environment Configuration"
    variables:
      - ${tenancy_ocid}
      - ${newrelic_endpoint}
  - title: "Key Vault Configuration"
    variables:
      - ${create_vault}
      - ${newrelic_ingest_api_key}
      - ${newrelic_user_api_key}
      - ${user_key_secret_ocid}
      - ${ingest_key_secret_ocid}
  - title: "New Relic Account Linking Configuration"
    variables:
      - ${newrelic_account_id}
      - ${linked_account_id}
      - ${link_account_name}
      - ${policy_stack}
  - title: "OCI WIF Configuration"
    visible:
      or:
        - eq:
            - ${policy_stack}
            - "METRICS,COMMON"
        - eq:
            - ${policy_stack}
            - "LOGS,COMMON"
        - eq:
            - ${policy_stack}
            - "METRICS,LOGS,COMMON"
    variables:
      - ${client_id}
      - ${client_secret}
      - ${oci_domain_url}
      - ${svc_user_name}

variables:
  tenancy_ocid:
    type: string
    title: Tenancy OCID
    description: OCI tenant OCID, more details can be found at https://docs.cloud.oracle.com/en-us/iaas/Content/API/Concepts/apisigningkey.htm#five
    required: true
    visible: true

  current_user_ocid:
    type: string
    title: User OCID
    description: The OCID of the current user executing the terraform script.
    required: true
    visible: false

  region:
    type: string
    title: Region
    description: OCI Region as documented at https://docs.cloud.oracle.com/en-us/iaas/Content/General/Concepts/regions.htm
    required: true
    visible: false

  compartment_ocid:
    type: string
    title: Compartment OCID
    description: The OCID of the compartment where the resources will be created.
    required: true
    visible: false

  newrelic_endpoint:
    type: enum
    title: New Relic Endpoint
    description: The endpoint to hit for sending the metrics. Varies by region [US|EU]
    required: true
    allowMultiple: false
    default: US
    enum:
      - US
      - EU

  newrelic_ingest_api_key:
    type: password
    title: New Relic Ingest License API Key
    description: The Ingest License API key for sending metrics to New Relic endpoints
    required: true
    sensitive: true
    visible:
      and:
        - ${create_vault}
        - or:
            - eq:
                - ${policy_stack}
                - "METRICS,COMMON"
            - eq:
                - ${policy_stack}
                - "LOGS,COMMON"
            - eq:
                - ${policy_stack}
                - "METRICS,LOGS,COMMON"

  newrelic_user_api_key:
    type: password
    title: New Relic User API Key
    description: The User API key for Linking the OCI Account to the New Relic account
    required: true
    sensitive: true
    visible: ${create_vault}

  newrelic_account_id:
    type: string
    title: New Relic Account ID
    description: The New Relic Account ID for linking the OCI account to the New Relic account
    required: true
    confirmation: true


  linked_account_id:
    type: string
    title: New Relic Provider ID
    description: The Provider ID for OCI in New Relic
    required: true
    visible:
      or:
        - eq:
            - ${policy_stack}
            - "METRICS"
        - eq:
            - ${policy_stack}
            - "LOGS"


  link_account_name:
    type: string
    title: New Relic Provider Account Name
    description: The name assigned to the linked account created under New Relic account
    required: true
    visible:
      or:
        - eq:
            - ${policy_stack}
            - "METRICS,COMMON"
        - eq:
            - ${policy_stack}
            - "LOGS,COMMON"
        - eq:
            - ${policy_stack}
            - "METRICS,LOGS,COMMON"

  policy_stack:
    type: string
    title: New Relic Policy Instrumentation
    description: A string indicating which parts of the stack to deploy. Use comma-separated values from METRICS, LOGS, COMMON.
    visible: true
    required: true

  client_id:
    type: string
    title: Client ID
    description: The Client ID for OCI tenancy, needed for metadata polling from New Relic.
    required: true
    visible: true

  client_secret:
    type: password
    title: Client Secret
    description: The Client Secret for the OCI tenancy, needed for metadata polling from New Relic.
    required: true
    sensitive: true
    visible: true

  oci_domain_url:
    type: string
    title: OCI Domain URL
    description: The OCI Domain URL.
    required: true
    visible: true

  create_vault:
    type: boolean
    title: Create Key Vault
    description: Indicate whether a new Key Vault should be created for the New Relic secrets. If an existing secret is being used, its OCID must be provided.
    required: true
    default: true
    visible: true

  user_key_secret_ocid:
    type: string
    title: User Key Secret OCID
    sensitive: true
    description: The OCID of the secret that contains the New Relic user key.
    required: true
    visible:
      not:
        - ${create_vault}

  ingest_key_secret_ocid:
    type: string
    title: Ingest License Key Secret OCID
    sensitive: true
    description: The OCID of the secret that contains the New Relic ingest license key.
    required: true
    visible:
      and:
        - eq:
            - ${create_vault}
            - false
        - or:
            - eq:
                - ${policy_stack}
                - "METRICS,COMMON"
            - eq:
                - ${policy_stack}
                - "LOGS,COMMON"
            - eq:
                - ${policy_stack}
                - "METRICS,LOGS,COMMON"


